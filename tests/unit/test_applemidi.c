#include "cmocka_inc.h"

#include "applemidi.h"

static int test_applemidi_setup(UNUSED void** state)
{
    return 0;
}

static void test_applemidi_parses_rtpmidi_packet_with_single_midi_event(
    UNUSED void** state)
{
    char rtp_packet[1024]
        = { /* V P X CC M PT */ 0x80, 0x61, /* sequence number */ 0x8c, 0x24,
              /* timestamp */ 0x00, 0x58, 0xbb, 0x40, /* SSRC */ 0xac, 0x67,
              0xe1, 0x08, /* MIDI command section */ 0x03, 0x90, 0x48, 0x6f };

    size_t len = sizeof(rtp_packet);

    expect_midi_emit(0x90);
    expect_midi_emit(0x48);
    expect_midi_emit(0x6f);

    mw_err err = applemidi_processSessionMidiPacket(rtp_packet, len);
    assert_int_equal(err, MW_ERR_NONE);
}

static void test_applemidi_parses_rtpmidi_packet_with_single_2_byte_midi_event(
    UNUSED void** state)
{
    const u8 statuses[] = { 0xC0, 0xD0, 0xF1, 0xF3 };

    for (u16 i = 0; i < sizeof(statuses); i++) {
        u8 status = statuses[i];
        char rtp_packet[1024] = { /* V P X CC M PT */ 0x80, 0x61,
            /* sequence number */ 0x8c, 0x24,
            /* timestamp */ 0x00, 0x58, 0xbb, 0x40, /* SSRC */ 0xac, 0x67, 0xe1,
            0x08, /* MIDI command section */ 0x02, status, 0x01 };
        size_t len = sizeof(rtp_packet);

        expect_midi_emit(status);
        expect_midi_emit(0x01);

        mw_err err = applemidi_processSessionMidiPacket(rtp_packet, len);
        assert_int_equal(err, MW_ERR_NONE);
    }
}

static void
test_applemidi_parses_rtpmidi_packet_with_multiple_2_byte_midi_events(
    UNUSED void** state)
{
    const u8 statuses[] = { 0xC0, 0xD0, 0xF1, 0xF3 };

    for (u16 i = 0; i < sizeof(statuses); i++) {
        u8 status = statuses[i];
        char rtp_packet[1024] = { /* V P X CC M PT */ 0x80, 0x61,
            /* sequence number */ 0x8c, 0x24,
            /* timestamp */ 0x00, 0x58, 0xbb, 0x40, /* SSRC */ 0xac, 0x67, 0xe1,
            0x08, /* MIDI command section */ 0x05, status, 0x01, 0x00, status,
            0x01 };
        size_t len = sizeof(rtp_packet);

        expect_midi_emit(status);
        expect_midi_emit(0x01);
        expect_midi_emit(status);
        expect_midi_emit(0x01);

        mw_err err = applemidi_processSessionMidiPacket(rtp_packet, len);
        assert_int_equal(err, MW_ERR_NONE);
    }
}

static void
test_applemidi_parses_rtpmidi_packet_with_single_midi_event_long_header(
    UNUSED void** state)
{
    char rtp_packet[1024] = { /* V P X CC M PT */ 0x80, 0x61,
        /* sequence number */ 0x8c, 0x24,
        /* timestamp */ 0x00, 0x58, 0xbb, 0x40, /* SSRC */ 0xac, 0x67, 0xe1,
        0x08, /* MIDI command section */ 0xC0, 0x03, 0x90, 0x48, 0x6f };

    size_t len = sizeof(rtp_packet);

    expect_midi_emit(0x90);
    expect_midi_emit(0x48);
    expect_midi_emit(0x6f);

    mw_err err = applemidi_processSessionMidiPacket(rtp_packet, len);
    assert_int_equal(err, MW_ERR_NONE);
}

static void test_applemidi_parses_rtpmidi_packet_with_two_midi_events(
    UNUSED void** state)
{
    char rtp_packet[1024]
        = { /* V P X CC M PT */ 0x80, 0x61, /* sequence number */ 0x8c, 0x24,
              /* timestamp */ 0x00, 0x58, 0xbb, 0x40, /* SSRC */ 0xac, 0x67,
              0xe1, 0x08, /* MIDI command section */ 0x06, 0x90, 0x48, 0x6f,
              0x00, 0x51, 0x6f };

    size_t len = sizeof(rtp_packet);

    expect_midi_emit(0x90);
    expect_midi_emit(0x48);
    expect_midi_emit(0x6f);

    expect_midi_emit(0x90);
    expect_midi_emit(0x51);
    expect_midi_emit(0x6f);

    mw_err err = applemidi_processSessionMidiPacket(rtp_packet, len);
    assert_int_equal(err, MW_ERR_NONE);
}

static void test_applemidi_parses_rtpmidi_packet_with_multiple_midi_events(
    UNUSED void** state)
{
    char rtp_packet[1024]
        = { /* V P X CC M PT */ 0x80, 0x61, /* sequence number */ 0x8c, 0x24,
              /* timestamp */ 0x00, 0x58, 0xbb, 0x40, /* SSRC */ 0xac, 0x67,
              0xe1, 0x08, /* MIDI command section */ 0x09, 0x90, 0x48, 0x6f,
              0x00, 0x51, 0x6f, 0x00, 0x48, 0x6f };

    size_t len = sizeof(rtp_packet);

    expect_midi_emit(0x90);
    expect_midi_emit(0x48);
    expect_midi_emit(0x6f);

    expect_midi_emit(0x90);
    expect_midi_emit(0x51);
    expect_midi_emit(0x6f);

    expect_midi_emit(0x90);
    expect_midi_emit(0x48);
    expect_midi_emit(0x6f);

    mw_err err = applemidi_processSessionMidiPacket(rtp_packet, len);
    assert_int_equal(err, MW_ERR_NONE);
}

static void test_applemidi_parses_rtpmidi_packet_with_sysex(UNUSED void** state)
{
    char rtpPacket[1024] = { /* V P X CC M PT */ 0x80, 0x61,
        /* sequence number */ 0x8c, 0x24,
        /* timestamp */ 0x00, 0x58, 0xbb, 0x40, /* SSRC */ 0xac, 0x67, 0xe1,
        0x08, /* MIDI command section */ 0x05, 0xF0, 0x12, 0x34, 0x56, 0xF7 };

    size_t len = sizeof(rtpPacket);

    expect_midi_emit(0xF0);
    expect_midi_emit(0x12);
    expect_midi_emit(0x34);
    expect_midi_emit(0x56);
    expect_midi_emit(0xF7);

    mw_err err = applemidi_processSessionMidiPacket(rtpPacket, len);
    assert_int_equal(err, MW_ERR_NONE);
}

static void
test_applemidi_parses_rtpmidi_packet_with_multiple_different_midi_events(
    UNUSED void** state)
{
    char rtp_packet[1024]
        = { /* V P X CC M PT */ 0x80, 0x61, /* sequence number */ 0x8c, 0x24,
              /* timestamp */ 0x00, 0x58, 0xbb, 0x40, /* SSRC */ 0xac, 0x67,
              0xe1, 0x08, /* MIDI command section */ 0x0A, 0x90, 0x48, 0x6f,
              0x00, 0x51, 0x6f, 0x00, 0x80, 0x48, 0x6f };

    size_t len = sizeof(rtp_packet);

    expect_midi_emit(0x90);
    expect_midi_emit(0x48);
    expect_midi_emit(0x6f);

    expect_midi_emit(0x90);
    expect_midi_emit(0x51);
    expect_midi_emit(0x6f);

    expect_midi_emit(0x80);
    expect_midi_emit(0x48);
    expect_midi_emit(0x6f);

    mw_err err = applemidi_processSessionMidiPacket(rtp_packet, len);
    assert_int_equal(err, MW_ERR_NONE);
}

static void test_applemidi_parses_notes_sysex_cc_in_one_packet(
    UNUSED void** state)
{
    char rtp_packet[] = { /* V P X CC M PT */ 0x80, 0x61,
        /* sequence number */ 0xe0, 0x19, /* timestamp */ 0x03, 0x31, 0xdd,
        0x6d, /* SSRC */ 0x09, 0x0f, 0x92, 0xe9,
        /* MIDI command section */ 0xc0, 0x61, /* cmds */ 0xb0, 0x00, 0x00,
        0x00, /* cmd */ 0xc0, 0x00, 0x00, /* cmd */ 0xf7, 0x00, 0xf0, 0x01,
        0xb0, 0x00, 0x00, 0x00, 0xb1, 0x5d, 0x00, 0x06, 0xb3, 0x00, 0x00, 0x00,
        0xc3, 0x00, 0x00, 0xf7, 0x00, 0xf0, 0x01, 0xb3, 0x00, 0x00, 0x05, 0xb4,
        0x00, 0x00, 0x00, 0xc4, 0x00, 0x00, 0xf7, 0x00, 0xf0, 0x01, 0xb4, 0x00,
        0x00, 0x05, 0xb5, 0x00, 0x00, 0x00, 0xc5, 0x00, 0x00, 0xf7, 0x00, 0xf0,
        0x01, 0xb5, 0x00, 0x00, 0x04, 0xb6, 0x00, 0x00, 0x01, 0xc6, 0x00, 0x00,
        0xf7, 0x00, 0xf0, 0x00, 0xb6, 0x00, 0x00, 0x04, 0xb7, 0x00, 0x00, 0x00,
        0xc7, 0x00, 0x00, 0xf7, 0x00, 0xf0, 0x01, 0xb7, 0x00, 0x00, 0x00, 0xe9,
        0x00, 0x00, 0xaf, 0xdf, 0xd4, 0x80, 0x11, 0x48, 0x80, 0xc0, 0x00, 0x80,
        0x3b, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0xa0, 0x5a, 0x88, 0x0a,
        0x48, 0x80, 0xc0, 0x00, 0x80, 0x56, 0x60, 0x80, 0x90, 0x06, 0x40, 0x80,
        0xc0, 0x00, 0x98, 0x06, 0x40, 0x80, 0xc0, 0x00, 0xa0, 0x0a, 0x48, 0x80,
        0xc0, 0x00, 0x80, 0x78, 0x24, 0xda, 0xa8, 0x06, 0x40, 0x80, 0xc0, 0x00,
        0xb0, 0x06, 0x40, 0x80, 0xc0, 0x00, 0xb8, 0x0a, 0x48, 0x80, 0xc0, 0x00,
        0x80, 0x78, 0x0c, 0xd2, 0xc0, 0x06, 0x40, 0x80, 0xc0, 0x00, 0xc8, 0x09,
        0x48, 0x80, 0xc0, 0x00, 0x80, 0x55, 0x80, 0xd0, 0x06, 0x40, 0x80, 0xc0,
        0x00, 0xd8, 0x06, 0x40, 0x80, 0xc0, 0x00, 0xe0, 0x06, 0x40, 0x80, 0xc0,
        0x00, 0xe8, 0x06, 0x40, 0x80, 0xc0, 0x00, 0xf0, 0x06, 0x40, 0x80, 0xc0,
        0x00, 0xf8, 0x06, 0x40, 0x80, 0xc0, 0x00 };

    size_t len = sizeof(rtp_packet);

    expect_midi_emit_trio(0xb0, 0x00, 0x00);
    expect_midi_emit_duo(0xc0, 0x00);
    expect_midi_emit_trio(0xf7, 0x00, 0xf0);
    expect_midi_emit_trio(0xb0, 0x00, 0x00);

    mw_err err = applemidi_processSessionMidiPacket(rtp_packet, len);
    assert_int_equal(err, MW_ERR_NONE);
}

static void test_applemidi_ignores_middle_sysex_segments(UNUSED void** state)
{
    u8 cmd_length = 11;
    char rtp_packet[] = { /* V P X CC M PT */ 0x80, 0x61,
        /* sequence number */ 0xe0, 0x19, /* timestamp */ 0x03, 0x31, 0xdd,
        0x6d, /* SSRC */ 0x09, 0x0f, 0x92, 0xe9,
        /* MIDI command section */ 0xc0, cmd_length, /* cmds */ 0x90, 0x60,
        0x61, 0x00, /* | */ 0xF7, 0x00, 0xF0, 0x01,
        /* | */ 0x90, 0x60, 0x61 };

    size_t len = sizeof(rtp_packet);

    expect_midi_emit_trio(0x90, 0x60, 0x61);
    expect_midi_emit_trio(0x90, 0x60, 0x61);

    mw_err err = applemidi_processSessionMidiPacket(rtp_packet, len);
    assert_int_equal(err, MW_ERR_NONE);
}
